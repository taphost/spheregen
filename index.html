<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>SphereGen - Wireframe Sphere Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #fff;
      overflow: hidden;
    }
    
    #app {
      display: grid;
      grid-template-columns: 1fr 320px;
      height: 100vh;
    }
    
    #canvas-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      transition: background-color 0.3s;
      width: 100%;
      height: 100%;
    }
    
    #canvas-container canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }
    
    #controls-panel {
      background: #2a2a2a;
      padding: 15px;
      overflow-y: auto !important;
      overflow-x: hidden;
      border-left: 2px solid #444;
    }
    
    #mobile-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #00ffff;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,255,255,0.4);
      transition: all 0.3s;
    }
    
    #mobile-toggle:active {
      transform: scale(0.95);
    }
    
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #00ffff;
      text-align: center;
    }
    
    .control-group {
      margin-bottom: 12px;
      padding: 10px;
      background: #333;
      border-radius: 6px;
    }
    
    .control-group h3 {
      font-size: 12px;
      margin-bottom: 8px;
      color: #00ffff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .control-item {
      margin-bottom: 8px;
    }
    
    label {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
      color: #aaa;
    }
    
    input[type="range"] {
      width: 100%;
      height: 6px;
      background: #555;
      outline: none;
      border-radius: 3px;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #00ffff;
      cursor: pointer;
      border-radius: 50%;
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #00ffff;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }
    
    input[type="color"] {
      width: 100%;
      height: 45px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .color-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .color-row .control-item {
      margin-bottom: 0;
    }
    
    .value-display {
      display: inline-block;
      float: right;
      color: #00ffff;
      font-weight: bold;
    }
    
    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 12px;
    }
    
    button {
      padding: 10px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      transition: all 0.3s;
      touch-action: manipulation;
    }
    
    button:hover {
      background: #555;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button.primary {
      background: #00ffff;
      color: #000;
    }
    
    button.primary:hover {
      background: #00cccc;
    }
    
    button.danger {
      background: #ff4444;
    }
    
    button.danger:hover {
      background: #cc0000;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    #code-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      padding: 20px;
    }
    
    #code-modal.active {
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    #code-content {
      flex: 1;
      background: #1a1a1a;
      border: 2px solid #00ffff;
      border-radius: 8px;
      padding: 15px;
      overflow: auto;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.5;
      white-space: pre;
      color: #00ffff;
    }
    
    #copy-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #00ffff;
      color: #000;
      padding: 20px 40px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    #copy-notification.show {
      opacity: 1;
    }
    
    /* Mobile Styles */
    @media (max-width: 768px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
      }
      
      #canvas-container {
        grid-row: 1;
        height: 100vh;
      }
      
      #controls-panel {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        height: 70vh;
        max-height: 70vh;
        border-left: none;
        border-top: 2px solid #444;
        z-index: 1000;
        transition: bottom 0.3s ease;
        border-radius: 20px 20px 0 0;
        padding: 12px;
      }
      
      #controls-panel.open {
        bottom: 0;
      }
      
      #mobile-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      h1 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      
      .control-group {
        padding: 8px;
        margin-bottom: 10px;
      }
      
      .control-group h3 {
        font-size: 11px;
        margin-bottom: 6px;
      }
      
      .control-item {
        margin-bottom: 6px;
      }
      
      .button-group {
        gap: 6px;
      }
      
      button {
        padding: 10px;
        font-size: 11px;
      }
      
      #code-modal {
        padding: 10px;
      }
      
      #code-content {
        padding: 10px;
        font-size: 10px;
      }
      
      .modal-header button {
        padding: 10px 15px;
      }
      
      #copy-notification {
        padding: 15px 30px;
        font-size: 16px;
      }
    }
    
    @media (max-width: 480px) {
      #controls-panel {
        height: 80vh;
        max-height: 80vh;
        padding: 10px;
      }
      
      h1 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      .control-group {
        padding: 8px;
        margin-bottom: 8px;
      }
      
      .color-row {
        gap: 6px;
      }
      
      input[type="color"] {
        height: 40px;
      }
      
      .button-group {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      #mobile-toggle {
        width: 50px;
        height: 50px;
        font-size: 20px;
        bottom: 15px;
        right: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="canvas-container"></div>
    
    <div id="controls-panel">
      <h1>SPHEREGEN</h1>
      
      <div class="control-group">
        <h3>Geometry</h3>
        <div class="control-item">
          <label>Radius <span class="value-display" id="radius-val">2</span></label>
          <input type="range" id="radius" min="0.5" max="5" step="0.1" value="2">
        </div>
        <div class="control-item">
          <label>Width Segments <span class="value-display" id="width-val">32</span></label>
          <input type="range" id="widthSegments" min="8" max="64" step="4" value="32">
        </div>
        <div class="control-item">
          <label>Height Segments <span class="value-display" id="height-val">32</span></label>
          <input type="range" id="heightSegments" min="8" max="64" step="4" value="32">
        </div>
      </div>
      
      <div class="control-group">
        <h3>Rotation</h3>
        <div class="control-item">
          <label>Speed X <span class="value-display" id="speedx-val">0.002</span></label>
          <input type="range" id="speedX" min="-0.05" max="0.05" step="0.001" value="0.002">
        </div>
        <div class="control-item">
          <label>Speed Y <span class="value-display" id="speedy-val">0.004</span></label>
          <input type="range" id="speedY" min="-0.05" max="0.05" step="0.001" value="0.004">
        </div>
        <div class="control-item">
          <label>Speed Z <span class="value-display" id="speedz-val">0.000</span></label>
          <input type="range" id="speedZ" min="-0.05" max="0.05" step="0.001" value="0">
        </div>
        <div class="control-item">
          <label>Angle X <span class="value-display" id="anglex-val">0</span></label>
          <input type="range" id="angleX" min="0" max="360" step="1" value="0">
        </div>
        <div class="control-item">
          <label>Angle Y <span class="value-display" id="angley-val">0</span></label>
          <input type="range" id="angleY" min="0" max="360" step="1" value="0">
        </div>
      </div>
      
      <div class="control-group">
        <h3>Effects</h3>
        <div class="control-item">
          <label>Frequency <span class="value-display" id="freq-val">1.0</span></label>
          <input type="range" id="frequency" min="0" max="5" step="0.1" value="1">
        </div>
        <div class="control-item">
          <label>Amplitude <span class="value-display" id="amp-val">0.05</span></label>
          <input type="range" id="amplitude" min="0" max="0.5" step="0.01" value="0.05">
        </div>
        <div class="control-item">
          <label>Randomness <span class="value-display" id="rand-val">0.0</span></label>
          <input type="range" id="randomness" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-item">
          <label>Flickering <span class="value-display" id="flicker-val">0.0</span></label>
          <input type="range" id="flickering" min="0" max="1" step="0.01" value="0">
        </div>
      </div>
      
      <div class="control-group">
        <h3>Colors</h3>
        <div class="color-row">
          <div class="control-item">
            <label>Sphere</label>
            <input type="color" id="sphereColor" value="#00ffff">
          </div>
          <div class="control-item">
            <label>Background</label>
            <input type="color" id="bgColor" value="#000000">
          </div>
        </div>
        <div class="control-item checkbox-container">
          <input type="checkbox" id="invertColors">
          <label style="margin: 0">Invert Colors</label>
        </div>
        <div class="control-item">
          <label>Opacity <span class="value-display" id="opacity-val">0.6</span></label>
          <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.6">
        </div>
      </div>
      
      <div class="button-group">
        <button id="playBtn" class="primary">‚ñ∂ PLAY</button>
        <button id="pauseBtn">‚è∏ PAUSE</button>
        <button id="resetBtn" class="danger">‚Üª RESET</button>
        <button id="savePngBtn">üíæ PNG</button>
        <button id="saveHtmlBtn">üìÑ HTML</button>
        <button id="showCodeBtn">üëÅ CODE</button>
      </div>
    </div>
  </div>
  
  <button id="mobile-toggle">‚öôÔ∏è</button>
  
  <div id="code-modal">
    <div class="modal-header">
      <button id="copyCodeBtn" class="primary">üìã COPY</button>
      <button id="closeModalBtn">‚úñ CLOSE</button>
    </div>
    <div id="code-content"></div>
  </div>
  
  <div id="copy-notification">Code Copied to Clipboard!</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Application state
    const state = {
      radius: 2,
      widthSegments: 32,
      heightSegments: 32,
      speedX: 0.002,
      speedY: 0.004,
      speedZ: 0,
      angleX: 0,
      angleY: 0,
      frequency: 1,
      amplitude: 0.05,
      randomness: 0,
      flickering: 0,
      sphereColor: '#00ffff',
      bgColor: '#000000',
      invertColors: false,
      opacity: 0.6,
      isPlaying: true
    };
    
    const defaultState = {...state};
    
    // Three.js setup
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.z = 5;
    const initialCameraZ = 5;
    
    const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    
    // Lights
    const ambientLight = new THREE.AmbientLight(0x404040);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);
    
    // Wireframe sphere
    let sphereGroup = new THREE.Group();
    let wireframeMesh;
    let currentGeometry;
    let currentMaterial;
    
    function createSphere() {
      // Dispose previous resources to prevent memory leak
      if (wireframeMesh) {
        sphereGroup.remove(wireframeMesh);
      }
      if (currentGeometry) {
        currentGeometry.dispose();
      }
      if (currentMaterial) {
        currentMaterial.dispose();
      }
      
      const geometry = new THREE.SphereGeometry(
        state.radius, 
        state.widthSegments, 
        state.heightSegments
      );
      
      const wireframe = new THREE.WireframeGeometry(geometry);
      currentGeometry = wireframe;
      
      const color = state.invertColors ? state.bgColor : state.sphereColor;
      const lineMaterial = new THREE.LineBasicMaterial({ 
        color: color,
        transparent: true, 
        opacity: state.opacity
      });
      currentMaterial = lineMaterial;
      
      wireframeMesh = new THREE.LineSegments(wireframe, lineMaterial);
      sphereGroup.add(wireframeMesh);
      
      // Dispose original geometry as we only need wireframe
      geometry.dispose();
    }
    
    scene.add(sphereGroup);
    createSphere();
    
    // Cache DOM elements
    const controls = {
      radius: document.getElementById('radius'),
      widthSegments: document.getElementById('widthSegments'),
      heightSegments: document.getElementById('heightSegments'),
      speedX: document.getElementById('speedX'),
      speedY: document.getElementById('speedY'),
      speedZ: document.getElementById('speedZ'),
      angleX: document.getElementById('angleX'),
      angleY: document.getElementById('angleY'),
      frequency: document.getElementById('frequency'),
      amplitude: document.getElementById('amplitude'),
      randomness: document.getElementById('randomness'),
      flickering: document.getElementById('flickering'),
      sphereColor: document.getElementById('sphereColor'),
      bgColor: document.getElementById('bgColor'),
      invertColors: document.getElementById('invertColors'),
      opacity: document.getElementById('opacity')
    };
    
    const valueDisplays = {
      radius: document.getElementById('radius-val'),
      widthSegments: document.getElementById('width-val'),
      heightSegments: document.getElementById('height-val'),
      speedX: document.getElementById('speedx-val'),
      speedY: document.getElementById('speedy-val'),
      speedZ: document.getElementById('speedz-val'),
      angleX: document.getElementById('anglex-val'),
      angleY: document.getElementById('angley-val'),
      frequency: document.getElementById('freq-val'),
      amplitude: document.getElementById('amp-val'),
      randomness: document.getElementById('rand-val'),
      flickering: document.getElementById('flicker-val'),
      opacity: document.getElementById('opacity-val')
    };
    
    const buttons = {
      play: document.getElementById('playBtn'),
      pause: document.getElementById('pauseBtn'),
      reset: document.getElementById('resetBtn'),
      savePng: document.getElementById('savePngBtn'),
      saveHtml: document.getElementById('saveHtmlBtn'),
      showCode: document.getElementById('showCodeBtn'),
      copyCode: document.getElementById('copyCodeBtn'),
      closeModal: document.getElementById('closeModalBtn')
    };
    
    const mobileToggle = document.getElementById('mobile-toggle');
    const controlsPanel = document.getElementById('controls-panel');
    const codeModal = document.getElementById('code-modal');
    const codeContent = document.getElementById('code-content');
    
    // Animation
    let time = 0;
    function animate() {
      requestAnimationFrame(animate);
      
      if (state.isPlaying) {
        time += 0.016;
        
        // Base rotation
        sphereGroup.rotation.x += state.speedX;
        sphereGroup.rotation.y += state.speedY;
        sphereGroup.rotation.z += state.speedZ;
        
        // Oscillation effect
        if (state.amplitude > 0) {
          const scale = 1 + state.amplitude * Math.sin(time * state.frequency);
          sphereGroup.scale.set(scale, scale, scale);
        } else {
          // Reset scale when amplitude is 0
          sphereGroup.scale.set(1, 1, 1);
        }
        
        // Random movement
        if (state.randomness > 0) {
          sphereGroup.rotation.x += (Math.random() - 0.5) * state.randomness * 0.01;
          sphereGroup.rotation.y += (Math.random() - 0.5) * state.randomness * 0.01;
          sphereGroup.rotation.z += (Math.random() - 0.5) * state.randomness * 0.01;
        }
        
        // Flickering effect
        if (state.flickering > 0 && wireframeMesh) {
          const flickerAmount = state.flickering * 0.5;
          const newOpacity = state.opacity + (Math.random() - 0.5) * flickerAmount;
          wireframeMesh.material.opacity = Math.max(0.1, Math.min(1, newOpacity));
        } else if (wireframeMesh && wireframeMesh.material.opacity !== state.opacity) {
          // Reset opacity when flickering is disabled
          wireframeMesh.material.opacity = state.opacity;
        }
      }
      
      renderer.render(scene, camera);
    }
    
    // Update background color
    function updateBackground() {
      const color = state.invertColors ? state.sphereColor : state.bgColor;
      container.style.backgroundColor = color;
      renderer.setClearColor(color);
    }
    
    // Mobile toggle
    mobileToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      controlsPanel.classList.toggle('open');
    });
    
    // Close panel when clicking canvas on mobile (only if panel is open)
    container.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 && controlsPanel.classList.contains('open')) {
        controlsPanel.classList.remove('open');
      }
    });
    
    // Prevent clicks on control panel from closing it
    controlsPanel.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
    // Setup control event listeners
    function setupControls() {
      // Slider configuration with callbacks
      const sliderConfig = [
        { id: 'radius', precision: 1, callback: createSphere },
        { id: 'widthSegments', precision: 0, callback: createSphere },
        { id: 'heightSegments', precision: 0, callback: createSphere },
        { id: 'speedX', precision: 3 },
        { id: 'speedY', precision: 3 },
        { id: 'speedZ', precision: 3 },
        { id: 'angleX', precision: 0, callback: (val) => { sphereGroup.rotation.x = val * Math.PI / 180; } },
        { id: 'angleY', precision: 0, callback: (val) => { sphereGroup.rotation.y = val * Math.PI / 180; } },
        { id: 'frequency', precision: 1 },
        { id: 'amplitude', precision: 2 },
        { id: 'randomness', precision: 2 },
        { id: 'flickering', precision: 2 },
        { id: 'opacity', precision: 1, callback: createSphere }
      ];
      
      // Setup all sliders with loop
      sliderConfig.forEach(config => {
        const input = controls[config.id];
        const display = valueDisplays[config.id];
        
        if (input && display) {
          input.addEventListener('input', (e) => {
            const value = config.precision === 0 ? parseInt(e.target.value) : parseFloat(e.target.value);
            state[config.id] = value;
            display.textContent = config.precision === 0 ? value : value.toFixed(config.precision);
            if (config.callback) config.callback(value);
          });
        }
      });
      
      // Color controls
      controls.sphereColor.addEventListener('input', (e) => {
        state.sphereColor = e.target.value;
        createSphere();
        updateBackground();
      });
      
      controls.bgColor.addEventListener('input', (e) => {
        state.bgColor = e.target.value;
        updateBackground();
      });
      
      controls.invertColors.addEventListener('change', (e) => {
        state.invertColors = e.target.checked;
        createSphere();
        updateBackground();
      });
      
      // Action buttons
      buttons.play.addEventListener('click', () => { state.isPlaying = true; });
      buttons.pause.addEventListener('click', () => { state.isPlaying = false; });
      buttons.reset.addEventListener('click', resetToDefaults);
      buttons.savePng.addEventListener('click', savePNG);
      buttons.saveHtml.addEventListener('click', saveHTML);
      buttons.showCode.addEventListener('click', showCode);
      buttons.copyCode.addEventListener('click', copyCode);
      buttons.closeModal.addEventListener('click', () => { codeModal.classList.remove('active'); });
    }
    
    function resetToDefaults() {
      Object.assign(state, defaultState);
      time = 0;
      
      // Update all UI controls using cached references
      Object.keys(controls).forEach(key => {
        if (controls[key].type === 'checkbox') {
          controls[key].checked = state[key];
        } else {
          controls[key].value = state[key];
        }
      });
      
      // Update value displays
      Object.keys(valueDisplays).forEach(key => {
        const input = controls[key];
        if (input) valueDisplays[key].textContent = input.value;
      });
      
      sphereGroup.rotation.set(0, 0, 0);
      sphereGroup.scale.set(1, 1, 1);
      sphereGroup.position.set(0, 0, 0);
      
      createSphere();
      updateBackground();
    }
    
    function savePNG() {
      renderer.render(scene, camera);
      const dataURL = renderer.domElement.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = 'sphere-wireframe.png';
      link.href = dataURL;
      link.click();
    }
    
    function saveHTML() {
      const htmlContent = generateHTML();
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'sphere-wireframe.html';
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
    }
    
    function showCode() {
      codeContent.textContent = generateHTML();
      codeModal.classList.add('active');
    }
    
    function copyCode() {
      const code = codeContent.textContent;
      navigator.clipboard.writeText(code).then(() => {
        showNotification();
      });
    }
    
    // Show copy notification
    function showNotification() {
      const notification = document.getElementById('copy-notification');
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 2000);
    }
    
    // Generate standalone HTML
    function generateHTML() {
      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wireframe Sphere</title>
  <style>
    body { margin: 0; overflow: hidden; background: ${state.bgColor}; }
    #container { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="container"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
  <script>
    const container = document.getElementById('container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;
    
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor('${state.bgColor}');
    container.appendChild(renderer.domElement);
    
    const ambientLight = new THREE.AmbientLight(0x404040);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);
    
    const geometry = new THREE.SphereGeometry(${state.radius}, ${state.widthSegments}, ${state.heightSegments});
    const wireframe = new THREE.WireframeGeometry(geometry);
    const lineMaterial = new THREE.LineBasicMaterial({ 
      color: '${state.sphereColor}',
      transparent: true, 
      opacity: ${state.opacity}
    });
    
    const sphereGroup = new THREE.Group();
    const wireframeMesh = new THREE.LineSegments(wireframe, lineMaterial);
    sphereGroup.add(wireframeMesh);
    scene.add(sphereGroup);
    
    sphereGroup.rotation.x = ${state.angleX * Math.PI / 180};
    sphereGroup.rotation.y = ${state.angleY * Math.PI / 180};
    
    let time = 0;
    function animate() {
      requestAnimationFrame(animate);
      time += 0.016;
      
      sphereGroup.rotation.x += ${state.speedX};
      sphereGroup.rotation.y += ${state.speedY};
      sphereGroup.rotation.z += ${state.speedZ};
      
      ${state.amplitude > 0 ? `
      const scale = 1 + ${state.amplitude} * Math.sin(time * ${state.frequency});
      sphereGroup.scale.set(scale, scale, scale);
      ` : ''}
      
      ${state.randomness > 0 ? `
      sphereGroup.rotation.x += (Math.random() - 0.5) * ${state.randomness} * 0.01;
      sphereGroup.rotation.y += (Math.random() - 0.5) * ${state.randomness} * 0.01;
      sphereGroup.rotation.z += (Math.random() - 0.5) * ${state.randomness} * 0.01;
      ` : ''}
      
      ${state.flickering > 0 ? `
      const flickerAmount = ${state.flickering} * 0.5;
      const newOpacity = ${state.opacity} + (Math.random() - 0.5) * flickerAmount;
      wireframeMesh.material.opacity = Math.max(0.1, Math.min(1, newOpacity));
      ` : ''}
      
      renderer.render(scene, camera);
    }
    
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    animate();
  <\/script>
</body>
</html>`;
    }
    
    // Window resize handler
    let resizeTimeout;
    function handleResize() {
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(width, height, false);
      
      // Force scrollbar recalculation
      requestAnimationFrame(() => {
        const scrollTop = controlsPanel.scrollTop;
        controlsPanel.style.display = 'none';
        controlsPanel.offsetHeight; // Force reflow
        controlsPanel.style.display = '';
        controlsPanel.scrollTop = scrollTop;
      });
    }
    
    function debounceResize() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(handleResize, 50);
    }
    
    window.addEventListener('resize', debounceResize);
    
    // Handle fullscreen changes - reset camera position
    function handleFullscreenChange() {
      camera.position.z = initialCameraZ;
      handleResize();
    }
    
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('msfullscreenchange', handleFullscreenChange);
    
    // Initial resize to ensure proper sizing
    handleResize();
    
    // Initialize
    setupControls();
    updateBackground();
    animate();
  </script>
</body>
</html>